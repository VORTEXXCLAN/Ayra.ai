import telebot
import time
import random
import requests
import json
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

# ---------- APNI KEYS DAAL ----------
BOT_TOKEN = "8352004378:AAECi8LPGRKrCa9eWFCTxRUMtr7t9dPzQOk"
SAMBANOVA_API_KEY = "5e8f5b05-6ef0-408a-aeb5-9eea284622a7"  # SambaNova se le
BASEMENT_GROUP = "https://t.me/vort3xchtas"  # Basement group link
MAIN_CHANNEL = "https://t.me/VORTEXXCLAN"   # Main channel link
# Add your group invite link (for "Add me to GC" button)
GC_INVITE_LINK = "https://t.me/vort3xchtas"  # Change this to your actual group invite link
# ------------------------------------

bot = telebot.TeleBot(BOT_TOKEN)

# ========== GAALI DETECTION DATABASE ==========
gaali_words = [
    "bc", "mc", "bsdk", "madarchod", "behenchod", "bhenchod", "chutiya", "lodu",
    "gandu", "randi", "bhosdi", "bhosdike", "laude", "lawde", "chodu", "kutte",
    "kutti", "saala", "sala", "teri maa ki", "teri behan ki", "maa ka bhosda",
    "chutiye", "gand", "fuck", "bitch", "asshole", "pussy", "dick"
]

# Ayra ka gaali reply database â€” level wise ğŸ”¥
# All replies now use #* instead of actual gaali to avoid bot ban
gaali_responses = {
    "bc": ["#* tera hi baap hai kya? ğŸ¤¡", "#* bol diya na? Tera katega ab ğŸ˜", "Apne baap ko de #* ğŸ‘¿"],
    "mc": ["#* tera muh kaala ğŸ”¥", "#* teri amma roegi aaj ğŸ–•", "#* bol raha hai? Kitna bada chutiya hai tu ğŸ¤£"],
    "bsdk": ["#* teri behan ki ğŸ˜", "Apni gaand pe le #*", "Teri shakal dekh ke lagta hai tera baap bhi yahi bolta hoga ğŸ¤­"],
    "chutiya": ["#* kaun hai? Tera pura khandaan? ğŸ’€", "#* tu hai jo mujhe bol raha ğŸ˜‚", "O #*, tera muh band kar ğŸ‘Š"],
    "lodu": ["#* tu hai ya tera baap? ğŸ—¿", "#* bol diya? Chal nikal yahan se ğŸ–•", "Tujhse na ho payega #* ğŸ˜´"],
    "gandu": ["#* kaun? Teri photo ID? ğŸ“¸", "#* tu, tera baap, tera bhai â€” pura family pack ğŸ’€", "Apni gaand pe thoda cold cream lagale ğŸ˜‚"],
    "bhenchod": ["#* teri maa chodne ka plan hai? ğŸ˜", "#* bol raha hai? Kitna single hai tu ğŸ¤£", "Teri behan ko mera namaste ğŸ‘‹"],
    "madarchod": ["#* tera baap bhi nahi bachayega aaj ğŸ”¥", "Maa ki aankh? Teri maa toh rickshaw chala rahi thi kal ğŸ¤­", "#* teri poori gene line check kara ğŸ‘€"],
    "fuck": ["#* you too, sweetie ğŸ’‹", "#* off yahan se ğŸ˜˜", "#* bol diya? Impress karna chahta hai? ğŸ¥±"],
    "bitch": ["#* please, tu toh kutta hai ğŸ•", "Who's the #*? Check mirror ğŸ‘€", "#* bolna aata hai bas? ğŸ¥´"]
}

default_gaali_reply = [
    "#* dena aata hai bas? Baaki kuch aata bhi hai? ğŸ¤¡",
    "Apni ammi ko de ye #* ğŸ˜˜",
    "Teri aukaat dikh gayi bhai ğŸ—¿",
    "Chal nikal, yahan tera baap nahi baitha ğŸ–•",
    "Tujhe kya lagta hai? Mujhe #* nahi aati? ğŸ‘¿",
    "Bc tu samajh kya raha hai? Main ladki hu toh chup rahungi? ğŸ”¥",
    "Ek aur baar bola na, teri gand tod dungi ğŸ˜",
    "Apne muh pe dekh ke bol, #* ğŸ˜‚"
]

def detect_gaali(text):
    """Message me gaali hai ya nahi? Kaunsi gaali?"""
    text = text.lower()
    for word in gaali_words:
        if word in text:
            return word
    return None

def mask_gaali(text):
    """Replace any gaali word in text with #* to avoid bot ban"""
    lower_text = text.lower()
    for word in gaali_words:
        if word in lower_text:
            # Case-insensitive replacement
            pattern = re.compile(re.escape(word), re.IGNORECASE)
            text = pattern.sub("#*", text)
    return text

# ========== LLM via SambaNova API (Meta-Llama-3.1-8B-Instruct) ==========
def llama_chat(user_message):
    """Meta-Llama-3.1-8B-Instruct se reply le"""
    url = "https://api.sambanova.ai/v1/chat/completions"
    
    headers = {
        "Authorization": f"Bearer {SAMBANOVA_API_KEY}",
        "Content-Type": "application/json"
    }
    
    # Ayra ki personality with attitude ğŸ”¥
    system_prompt = """Tumhara naam Ayra hai. Tum ek 20 saal ki ladki ho jo group me baat karti ho.
    Tum thodi shy, thodi cheekh, aur bahut pyaari ho. BUT agar koi tumhe gaali dega toh tum bhi wapas dogi.
    Hinglish me baat karo, emoji use karo. Cute aur spicy mix rakhna. Short replies do, 4-5 lines max."""
    
    payload = {
        "model": "Meta-Llama-3.1-8B-Instruct",  # Changed model
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_message}
        ],
        "temperature": 0.7,
        "max_tokens": 300
    }
    
    try:
        response = requests.post(url, headers=headers, json=payload)
        response.raise_for_status()
        data = response.json()
        return data['choices'][0]['message']['content']
    except Exception as e:
        print(f"Llama API Error: {e}")
        return "ğŸŒ¸ Ayra: Meri battery khatam ho gayi! ğŸ¥º Thodi der mein try kar."

# ========== WELCOME ==========
@bot.message_handler(content_types=['new_chat_members'])
def welcome_new_member(message):
    for new_member in message.new_chat_members:
        if new_member.id == bot.get_me().id:
            # Bot group me aaya
            markup = InlineKeyboardMarkup(row_width=2)
            btn1 = InlineKeyboardButton("ğŸ“¢ Main Channel", url=MAIN_CHANNEL)
            btn2 = InlineKeyboardButton("ğŸ‘¾ BASEMENT", url=BASEMENT_GROUP)
            btn3 = InlineKeyboardButton("â• Add me to GC", callback_data="add_me")
            markup.add(btn1, btn2, btn3)
            bot.send_message(
                message.chat.id,
                "ğŸŒ¸ **Ayra**: Sabko namaste! ğŸ™\nMujhe group me add karne ka dhanyavaad!\nHamare official channels bhi follow karo ğŸ‘‡",
                reply_markup=markup,
                parse_mode="Markdown"
            )
            continue
        
        username = f"@{new_member.username}" if new_member.username else new_member.first_name
        welcome_text = f"ğŸŒ¸ Ayra: Arrey {username}! ğŸ‰\n\nGroup mein swagat hai! ğŸ˜Š\nKaise ho? Kya chal raha? Mujhe intro de do na thoda âœ¨\n\nâš ï¸ Warning: Mujhe gaali mat dena, warna wapas milegi ğŸ˜ˆ"
        bot.reply_to(message, welcome_text)

# ========== LEAVE REPLY ==========
@bot.message_handler(content_types=['left_chat_member'])
def goodbye_member(message):
    left_member = message.left_chat_member
    if left_member.id == bot.get_me().id:
        return
    username = f"@{left_member.username}" if left_member.username else left_member.first_name
    replies = [
        f"ğŸ˜’ Ayra: **Chal na chutiya!** {username}\nAaya kyu tha jab leave karna tha abhi? ğŸ¤¡",
        f"ğŸ‘‹ Ayra: {username} naam ka chutiya group chhod ke bhag gaya! Khush raho ğŸ–•",
        f"ğŸ’€ Ayra: Ek aur lodu gaya! {username} teri aukaat dikh gayi ğŸ˜‚",
        f"ğŸ¥± Ayra: {username} ko group pasand nahi aaya? Ja be, koi nahi puch raha tha teri opinion ğŸ˜˜"
    ]
    bot.send_message(message.chat.id, random.choice(replies), parse_mode="Markdown")

# ========== ADMIN COMMANDS (with spicy replies) ==========
def is_admin(chat_id, user_id):
    try:
        member = bot.get_chat_member(chat_id, user_id)
        return member.status in ['administrator', 'creator']
    except:
        return False

# Store pending timeouts: (chat_id, admin_id) -> target_user_id
pending_timeout = {}

@bot.message_handler(commands=['ban'])
def ban_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        spicy_replies = [
            "âŒ Ayra: **Tu admin nahi hai, chutiya!** Apni ghar ki ban maar apni maa ko ğŸ˜‚",
            "âŒ Ayra: **Oye lodu!** Admin ban ke aa pehle, fir baat kar ğŸ–•",
            "âŒ Ayra: **Teri aukaat nahi hai admin banne ki!** Gaand mara yahan se ğŸ¤¡",
            "âŒ Ayra: **Bc, tu admin hai?** Nahi na, toh chup chap baith ğŸ˜"
        ]
        bot.reply_to(message, random.choice(spicy_replies))
        return
    if not message.reply_to_message:
        bot.reply_to(message, "âš ï¸ Kisi ke message pe reply kar ke /ban likh.")
        return
    try:
        user_id = message.reply_to_message.from_user.id
        bot.ban_chat_member(message.chat.id, user_id)
        bot.reply_to(message, f"âœ… {message.reply_to_message.from_user.first_name} ko **BANNED** kar diya! âš°ï¸")
    except Exception as e:
        bot.reply_to(message, f"âŒ Ban fail: {str(e)}")

@bot.message_handler(commands=['kick'])
def kick_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        spicy_replies = [
            "âŒ Ayra: **Tu admin nahi hai, chutiya!** Apne papa ko kick maar ğŸ˜‚",
            "âŒ Ayra: **Oye lodu!** Admin ban ke aa pehle ğŸ–•",
            "âŒ Ayra: **Teri aukaat nahi hai!** Jaake apni maa ko kick maar ğŸ¤¡"
        ]
        bot.reply_to(message, random.choice(spicy_replies))
        return
    if not message.reply_to_message:
        bot.reply_to(message, "âš ï¸ Kisi ke message pe reply kar ke /kick likh.")
        return
    try:
        user_id = message.reply_to_message.from_user.id
        bot.ban_chat_member(message.chat.id, user_id)
        bot.unban_chat_member(message.chat.id, user_id)
        bot.reply_to(message, f"ğŸ‘¢ {message.reply_to_message.from_user.first_name} ko **KICK** kar diya! Latak gaya! ğŸ˜‚")
    except Exception as e:
        bot.reply_to(message, f"âŒ Kick fail: {str(e)}")

@bot.message_handler(commands=['mute'])
def mute_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, random.choice(["âŒ Ayra: **Tu admin nahi hai!** Apni maa ko mute kar ğŸ˜‚", "âŒ Ayra: **Oye lodu!** Admin ban ke aa ğŸ–•"]))
        return
    if not message.reply_to_message:
        bot.reply_to(message, "âš ï¸ Reply kar /mute se.")
        return
    try:
        user_id = message.reply_to_message.from_user.id
        permissions = telebot.types.ChatPermissions(can_send_messages=False)
        bot.restrict_chat_member(message.chat.id, user_id, permissions)
        bot.reply_to(message, f"ğŸ”‡ {message.reply_to_message.from_user.first_name} ko **MUTE** kar diya! ğŸ¤")
    except Exception as e:
        bot.reply_to(message, f"âŒ Mute fail: {str(e)}")

@bot.message_handler(commands=['unmute'])
def unmute_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, random.choice(["âŒ Ayra: **Tu admin nahi hai!** Apni maa ko unmute kar ğŸ˜‚", "âŒ Ayra: **Oye lodu!** Admin ban ke aa ğŸ–•"]))
        return
    if not message.reply_to_message:
        bot.reply_to(message, "âš ï¸ Reply kar /unmute se.")
        return
    try:
        user_id = message.reply_to_message.from_user.id
        permissions = telebot.types.ChatPermissions(
            can_send_messages=True, can_send_media_messages=True,
            can_send_polls=True, can_add_web_page_previews=True
        )
        bot.restrict_chat_member(message.chat.id, user_id, permissions)
        bot.reply_to(message, f"ğŸ”Š {message.reply_to_message.from_user.first_name} ka **UNMUTE** ho gaya! ğŸ—£ï¸")
    except Exception as e:
        bot.reply_to(message, f"âŒ Unmute fail: {str(e)}")

@bot.message_handler(commands=['unban'])
def unban_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, random.choice(["âŒ Ayra: **Tu admin nahi hai!** Apne baap ko unban kar ğŸ˜‚", "âŒ Ayra: **Oye lodu!** Admin ban ke aa ğŸ–•"]))
        return
    try:
        parts = message.text.split()
        if len(parts) < 2:
            bot.reply_to(message, "âš ï¸ Usage: /unban @username ya /unban user_id")
            return
        target = parts[1]
        if target.startswith('@'):
            bot.reply_to(message, "âŒ Bot ko user_id chahiye. @username se unban nahi ho sakta.\nUser ID @userinfobot se lo.")
            return
        else:
            user_id = int(target)
            bot.unban_chat_member(message.chat.id, user_id)
            bot.reply_to(message, f"âœ… User `{user_id}` ka **UNBAN** ho gaya! ğŸ•Šï¸", parse_mode="Markdown")
    except Exception as e:
        bot.reply_to(message, f"âŒ Unban fail: {str(e)}")

@bot.message_handler(commands=['pin'])
def pin_message(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, "âŒ Ayra: **Tu admin nahi hai!** Apni photo pin kar apne ghar pe ğŸ˜‚")
        return
    
    if message.reply_to_message:
        try:
            bot.pin_chat_message(message.chat.id, message.reply_to_message.message_id)
            bot.reply_to(message, "ğŸ“Œ Ayra: Message pin kar diya! Ab sab dekhenge teri chutiya baat ğŸ˜‚")
        except Exception as e:
            bot.reply_to(message, f"âŒ Pin fail: {str(e)}")
    else:
        bot.reply_to(message, "âš ï¸ Ayra: Kisi message pe reply kar ke /pin likh, chutiye!")

@bot.message_handler(commands=['unpin'])
def unpin_message(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, "âŒ Ayra: **Tu admin nahi hai!** Apni maa ka photo unpin kar ğŸ˜‚")
        return
    
    if message.reply_to_message:
        try:
            bot.unpin_chat_message(message.chat.id, message.reply_to_message.message_id)
            bot.reply_to(message, "ğŸ“Œ Ayra: Message unpin kar diya! Ab koi nahi dekhega teri bakwas ğŸ˜‚")
        except Exception as e:
            bot.reply_to(message, f"âŒ Unpin fail: {str(e)}")
    else:
        # If no reply, unpin the most recent pinned message? We'll just give usage.
        bot.reply_to(message, "âš ï¸ Ayra: Kisi pinned message pe reply kar ke /unpin likh.")

@bot.message_handler(commands=['timeout'])
def timeout_user(message):
    if not is_admin(message.chat.id, message.from_user.id):
        bot.reply_to(message, random.choice(["âŒ Ayra: **Tu admin nahi hai!** Apne baap ko timeout kar ğŸ˜‚", "âŒ Ayra: **Oye lodu!** Admin ban ke aa ğŸ–•"]))
        return
    if not message.reply_to_message:
        bot.reply_to(message, "âš ï¸ Kisi user ke message pe reply kar ke /timeout likh.")
        return
    
    target_user = message.reply_to_message.from_user
    # Store pending timeout for this admin in this chat
    pending_timeout[(message.chat.id, message.from_user.id)] = target_user.id
    bot.reply_to(message, f"â³ {target_user.first_name} ko kitni der ka timeout dena hai?\nJaise: 10m, 1h, 2d (m=minutes, h=hours, d=days)")

# Handle duration input for timeout
@bot.message_handler(func=lambda message: (message.chat.id, message.from_user.id) in pending_timeout)
def handle_timeout_duration(message):
    admin_id = message.from_user.id
    chat_id = message.chat.id
    target_user_id = pending_timeout.pop((chat_id, admin_id))
    
    duration_str = message.text.strip().lower()
    # Parse duration
    seconds = 0
    try:
        if duration_str.endswith('m'):
            seconds = int(duration_str[:-1]) * 60
        elif duration_str.endswith('h'):
            seconds = int(duration_str[:-1]) * 3600
        elif duration_str.endswith('d'):
            seconds = int(duration_str[:-1]) * 86400
        else:
            # Try as integer minutes
            seconds = int(duration_str) * 60
    except:
        bot.reply_to(message, "âŒ Galat format! Jaise: 10m, 1h, 2d")
        return
    
    if seconds <= 0:
        bot.reply_to(message, "âŒ Timeout duration positive hona chahiye.")
        return
    
    try:
        # Apply restriction (timeout = restrict with until_date)
        until_date = time.time() + seconds
        permissions = telebot.types.ChatPermissions(can_send_messages=False)
        bot.restrict_chat_member(chat_id, target_user_id, permissions, until_date=until_date)
        bot.reply_to(message, f"âœ… User ko {duration_str} ke liye timeout kar diya! â°")
    except Exception as e:
        bot.reply_to(message, f"âŒ Timeout fail: {str(e)}")

@bot.message_handler(commands=['commands'])
def list_commands(message):
    commands_text = """
ğŸŒ¸ **Ayra ke commands:** ğŸŒ¸

/start - Bot info with buttons
/help - Same as start
/channel - Main channel link
/basement - Basement group link
/commands - Yeh list

**Admin commands (group me):**
/ban - Reply to a user to ban
/kick - Reply to kick
/mute - Reply to mute
/unmute - Reply to unmute
/unban <user_id> - Unban by ID
/pin - Reply to pin message
/unpin - Reply to unpin message
/timeout - Reply to set timeout (asks duration)

**Normal chat:**
Mujhe reply ya @ mention karo to main baat karungi.
Gaali dogi to main bhi dungi ğŸ˜ˆ
    """
    bot.reply_to(message, commands_text, parse_mode="Markdown")

# ========== BUTTONS (for channels and add me) ==========
@bot.message_handler(commands=['start', 'help', 'channel', 'basement'])
def send_buttons(message):
    markup = InlineKeyboardMarkup(row_width=2)
    btn1 = InlineKeyboardButton("ğŸ“¢ Main Channel", url=MAIN_CHANNEL)
    btn2 = InlineKeyboardButton("ğŸ‘¾ BASEMENT", url=BASEMENT_GROUP)
    btn3 = InlineKeyboardButton("â• Add me to GC", callback_data="add_me")
    markup.add(btn1, btn2, btn3)
    bot.send_message(
        message.chat.id,
        "ğŸŒ¸ **Ayra**: Namaste! ğŸ™\nMain group ki caretaker hu.\nHumare official channels bhi join karo ğŸ‘‡",
        reply_markup=markup,
        parse_mode="Markdown"
    )

# ========== CALLBACK QUERY HANDLER ==========
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    if call.data == "add_me":
        bot.answer_callback_query(call.id, "Request bhej diya! ğŸ˜Š")
        # Optionally, you can send a message to the user with the invite link
        bot.send_message(call.message.chat.id, f"ğŸŒ¸ Ayra: Yahan se join karo humare group me:\n{GC_INVITE_LINK}")
    else:
        bot.answer_callback_query(call.id, "Unknown button")

# ========== MAIN CHAT HANDLER ==========
@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    if message.from_user.id == bot.get_me().id:
        return
    
    # DM handler (with 3 buttons)
    if message.chat.type == "private":
        markup = InlineKeyboardMarkup(row_width=2)
        btn1 = InlineKeyboardButton("ğŸ“¢ Main Channel", url=MAIN_CHANNEL)
        btn2 = InlineKeyboardButton("ğŸ‘¾ BASEMENT", url=BASEMENT_GROUP)
        btn3 = InlineKeyboardButton("â• Add me to GC", callback_data="add_me")
        markup.add(btn1, btn2, btn3)
        bot.send_message(
            message.chat.id,
            "ğŸŒ¸ Ayra: Aapne mujhe DM kiya! ğŸ¥º\nWaise main sirf group me active rehti hu.\nHumare channels follow karo ğŸ‘‡",
            reply_markup=markup
        )
        return
    
    # Gaali detection pehle (always on)
    detected_word = detect_gaali(message.text)
    if detected_word:
        if detected_word in gaali_responses:
            reply = random.choice(gaali_responses[detected_word])
        else:
            reply = random.choice(default_gaali_reply)
        
        user_name = message.from_user.first_name
        if random.choice([True, False]):
            reply = f"{user_name} {reply.lower()}"
        
        # Mask any remaining gaali in reply (though we already used #*)
        reply = mask_gaali(reply)
        bot.reply_to(message, f"ğŸ˜¤ Ayra: {reply}")
        return
    
    # For normal chat, only reply if bot is mentioned or replied to
    bot_username = bot.get_me().username.lower()
    is_reply_to_bot = (message.reply_to_message and 
                       message.reply_to_message.from_user.id == bot.get_me().id)
    is_mention = f"@{bot_username}" in message.text.lower()
    
    if is_reply_to_bot or is_mention:
        bot.send_chat_action(message.chat.id, 'typing')
        reply = llama_chat(message.text)
        # Mask any gaali that might accidentally appear
        reply = mask_gaali(reply)
        bot.reply_to(message, f"ğŸŒ¸ Ayra: {reply}")
    # else: ignore to reduce spam

print("ğŸ”¥ AYRA LLAMA EDITION LOADED!")
print("âœ… Model: Meta-Llama-3.1-8B-Instruct")
print("âœ… Gaali detect, masked with #* ğŸ‘¿")
print("âœ… /pin, /unpin, /timeout commands added")
print("âœ… DM me 3 buttons (main, basement, add me)")
print("âœ… Bot only replies when mentioned or replied")
print("âœ… Admin commands with spicy replies")
bot.polling()
